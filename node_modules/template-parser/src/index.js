const jsdom = require('jsdom')
const parser = require('./parser')
const { JSDOM } = jsdom

/**
 * 
 * @param {Object} template
 * 
 * {
 *    section: {
 *      is_multiple: boolean,
 *      selector: string
 *      fields: {
 *        fieldsName: {
 *          selector: string
 *          attribute: string
 *        } or {
 *          has_child: boolean
 *          selector: string
 *          fields: {...}
 *        }
 *      }
 *    }
 * } 
 * @param {String} html html string
 * @returns {Object} JSON
 */
module.exports = async (template, html) => {
  const dom = new JSDOM(html)
  const { document } = dom.window
  var result = {}
  for (const key of Object.keys(template)) {
    if (template[key].is_multiple) {
      result[key] = await parser(document, template[key])
    } else {
      const [res] = await parser(document, template[key])
      result[key] = res
    }
  }
  return result
}